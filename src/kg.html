<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Generation - mailr.</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .keygen-container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .keygen-header {
            font-size: 32px;
            font-weight: 700;
            color: #004aad;
            margin-bottom: 30px;
            text-align: center;
        }

        .spoiler {
            background-color: #202225;
            color: #202225;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            user-select: none;
            /* Prevent peeking by selection */
        }

        .spoiler.revealed {
            background-color: #f0f0f0;
            color: #333;
            user-select: text;
        }

        .key-display {
            font-family: monospace;
            padding: 15px;
            border-radius: 4px;
            background: #f8f9fa;
            word-break: break-all;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            min-height: 50px;
        }

        .spoiler-container {
            position: relative;
        }

        .spoiler-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #202225;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .spoiler-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">mailr.</div>
        <div class="header-right">
            <a href="../index.html">Home</a>
        </div>
    </header>

    <div class="container">
        <div class="keygen-container">
            <div class="keygen-header">Key Gen</div>

            <div id="initialState" style="text-align: center;">
                <p style="margin-bottom: 30px; font-size: 18px; color: #666;">Generate a cryptographically secure
                    keypair for your account.</p>
                <button class="btn" style="font-size: 18px; padding: 15px 40px;" onclick="generateKeysPage()">Generate
                    Keys</button>
            </div>

            <div id="resultState" style="display: none;">
                <div class="form-group">
                    <label style="font-size: 16px;">Public Key</label>
                    <div id="pubKeyDisplay" class="key-display"></div>
                </div>

                <div class="form-group">
                    <label style="font-size: 16px;">Private Key</label>
                    <div class="spoiler-container" onclick="toggleSpoiler(this)">
                        <div id="privKeyDisplay" class="key-display"></div>
                        <div class="spoiler-overlay">CLICK TO REVEAL</div>
                    </div>
                </div>

                <div style="display: flex; gap: 20px; margin-top: 40px;">
                    <button class="btn" onclick="downloadPubKey()"
                        style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>üì•</span> Download Public Key
                    </button>
                    <button class="btn" onclick="downloadPrivKey()"
                        style="flex: 1; background: #ffc107; color: #000; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>‚ö†Ô∏è</span> Download Private Key (.zip)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Web Crypto API Helper Functions

        async function generateKeyPair() {
            try {
                // 1. Generate Signing Key (ECDSA)
                const signKeyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "ECDSA",
                        namedCurve: "P-256"
                    },
                    true,
                    ["sign", "verify"]
                );

                // 2. Generate Encryption Key (ECDH)
                const encKeyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "ECDH",
                        namedCurve: "P-256"
                    },
                    true,
                    ["deriveKey", "deriveBits"]
                );

                // Export keys to JWK
                const signPub = await window.crypto.subtle.exportKey("jwk", signKeyPair.publicKey);
                const signPriv = await window.crypto.subtle.exportKey("jwk", signKeyPair.privateKey);
                const encPub = await window.crypto.subtle.exportKey("jwk", encKeyPair.publicKey);
                const encPriv = await window.crypto.subtle.exportKey("jwk", encKeyPair.privateKey);

                // Construct Combined Key Objects
                const publicKeyObj = {
                    version: "2.0",
                    type: "public",
                    algo: "ecc",
                    signing: signPub,
                    encryption: encPub
                };

                const privateKeyObj = {
                    version: "2.0",
                    type: "private",
                    algo: "ecc",
                    signing: signPriv,
                    encryption: encPriv
                };

                // Convert to compressed JSON string (Base64 encoded)
                const pubString = btoa(JSON.stringify(publicKeyObj));
                const privString = btoa(JSON.stringify(privateKeyObj));

                return { pubString, privString };

            } catch (e) {
                console.error(e);
                throw new Error("Crypto generation failed: " + e.message);
            }
        }

        async function generateKeysPage() {
            try {
                const keys = await generateKeyPair();

                document.getElementById('pubKeyDisplay').textContent = keys.pubString;
                document.getElementById('privKeyDisplay').textContent = keys.privString;

                document.getElementById('initialState').style.display = 'none';
                document.getElementById('resultState').style.display = 'block';

            } catch (error) {
                alert('Key generation failed: ' + error.message);
            }
        }

        function downloadPubKey() {
            const content = document.getElementById('pubKeyDisplay').textContent;
            downloadFile(content, 'mailr-public.key', 'text/plain');
        }

        function downloadPrivKey() {
            if (!confirm('‚ö†Ô∏è WARNING: You are downloading your PRIVATE KEY. Keep this file safe and NEVER share it!')) return;

            const content = document.getElementById('privKeyDisplay').textContent;
            downloadFile(content, 'mailr-private.key', 'text/plain');

            alert('Remember: Store this in a hidden .mailrkeys folder!');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>